create table total_salarycommission(dept_code varchar(4) references departments(d_code) on delete cascade, total_salary number not null, total_commission number);

insert into total_salarycommission  
select dept_code, sum(salary),sum(commission) from employees group by dept_code;



   	CREATE OR REPLACE TRIGGER departments_salary_commission
    AFTER 
    insert or UPDATE OR DELETE 
    ON employees
    begin
     	delete from TOTAL_SALARYCOMMISSION;
    	insert into total_salarycommission  
        select dept_code, sum(salary),sum(commission) from employees group by dept_code;
	end;


delete from employees where employees_id=111;   /*stmt : 1, number of rows : 1 trigger*/
update employees set salary=salary+5000 where salary<=60000;  /* stmt :1,  rows affect : n  trigger*/

select * from TOTAL_SALARYCOMMISSION;

insert into employees values(7878, 'Meera', 'Kumari', 'Pune', 45, 45000,5000,'HR');
insert into employees values(4545, 'Meera', 'Kumari', 'Pune', 45, 45000,null,'HR');



declare
    ids SYS.ODCINUMBERLIST:=SYS.ODCINUMBERLIST(4444,5555,1111,2222);
begin
	FOR i IN 1 .. ids.COUNT 
    LOOP
    	insert into employees(employees_id, salary, commission) values(ids(i), 50000, 2000);
  	END LOOP;
end;


create table oldemployees(emp_id number primary key, salary number, commission number, dept_code varchar(10));

insert into oldemployees values(1111, 45000,2000, 'SM');
insert into oldemployees values(2222, 45000,2000, 'HR');
insert into oldemployees values(3333, 45000,2000,'LD');

insert into employees(employees_id, salary, commission, dept_code)
select * from oldemployees; 
/*statement is 1,  number if rows affected 3 ,  stmt level trigger : 1 time gets fired*/

 update of table's particular column 


CREATE OR REPLACE TRIGGER departments_salary_commission
AFTER 
insert or UPDATE of salary, commission OR DELETE 
ON employees
begin
    delete from TOTAL_SALARYCOMMISSION;
    insert into total_salarycommission  
    select dept_code, sum(salary),sum(commission) from employees group by dept_code;
    dbms_output.put_line('trigger fired');
	exception
        when others then
         dbms_output.put_line(sqlerrm);
end;

update employees set age=67 where employees_id=111; // trigger will not get fired
update employees set salary=67000 where employees_id=111; // trigger fired



begin
    update employees set salary=salary+4000 where dept_code='WD';
	update employees set salary=salary+3000 where dept_code='SM';
	rollback;
end;
/*update : employee table update, trigger fire : TOTAL_SALARYCOMMISSION insert
update : employee tabe update , trigger fire : TOTAL_SALARYCOMMISSION insert
rollback*/

row level trigger,   




same table update

instead of

before

on viewname




CREATE OR REPLACE TRIGGER emp_totalsalary
AFTER 
insert or UPDATE of salary, commission OR DELETE 
ON employees
FOR EACH ROW
DECLARE
    v_salary NUMBER;
    v_commission NUMBER;
BEGIN
    -- Retrieve the salary and commission of the newly inserted employee
    SELECT salary, commission
    INTO v_salary, v_commission
    FROM employees
    WHERE employees_id = :NEW.employees_id;
    
    -- Calculate total salary and commission and update the inserted record in salarydetails
   /* UPDATE salarydetails
    SET total = v_salary + v_commission
    WHERE employees_id = :NEW.employees_id;*/
	update salarydetails set TOTAL= v_salary+nvl(v_commission, 0) where EMPLOYEES_ID=:NEW.employees_id;
END;


create table salarydetails(
    employees_id number references employees on delete cascade,
    total number
);

CREATE OR REPLACE TRIGGER emp_totalsalary
AFTER  
insert or update of salary, commission ON employees
FOR EACH ROW
declare empid number;
BEGIN
    delete from salarydetails where employees_id=:new.employees_id;
    insert into salarydetails values(:new.employees_id, :new.salary+nvl(:new.commission,0));
    dbms_output.put_line('trigger 2 fired');
END;

insert into employees values(111,'Kishor' ,'Pawar', 'Mumbai', 56, 80000, 2000,'WD');
insert into employees values(121,'Kamal' ,'Chopra', null, 40,70000,null,'HR');
insert into employees values(112,'Rupa' ,'Wagh', 'Pune', 56,75000,5000,'WD');
insert into employees values(131,'karuna' ,'Trivedi', 'Solapur', 46,65000,3000,'LD');
insert into employees values(115,'rupali' ,'Patil', 'pune', 45,75000,null,'SM');

update employees set salary=salary+5000 where dept_code='WD';

stmt : 1, number of rows affected : 2
    1st fire
    111 old record delete,  re insert
    2nd fire
    112 old record delete, re insert


